<script>
    var timeoutRequest;
    var loading = true;
    var isComplete = true;
    $.ajaxSetup({
        beforeSend: function () {
            isComplete = false;
            if (loading) {
                $("#wrap_loading").removeClass("d-none");
            }
        },
        complete: function () {
            if (isComplete) {
                $("#wrap_loading").addClass("d-none");
                $('#progress').width('0%').text('0%');
            }
        }
    });
</script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        min-height: 100vh;
        position: relative;
    }

    #wrap_loading {
        position: fixed;
        top: 0;
        left: 0;
        background-color: #00000088;
        width: 100%;
        height: 100%;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #wrap_loading h1 {
        color: #fff;
    }
</style>

<div class="d-none" id="wrap_loading">
    <h1 class="w-75 text-center" id="crawling_status">Đang cào dữ liệu...</h1>
</div>

<div class="controller p-3">
    <h3>Nhập url để cào</h3>
    <input class="form-control w-25" id="url-crawl" type="text"><br>
    <button type="button" id="btn-crawl" class="btn btn-primary">Let's cook</button>
</div>

<script>
    var attemp = 1;
    swal({
        title: "CHÚ Ý!",
        text: "1. Khi đang cào không nên tắt hoặc thoát, nếu không thì sẽ dẫn đến điều số 2.\n2. Nếu số lượng chap cào được nhỏ hơn tổng số chap, HÃY cào lại cho đến khi nào bằng tổng số chap thì dừng.",
        icon: "warning",
        dangerMode: true,
        button: "Ok",
    });

    $(document).ready(function () {
        const CrawlerService = (() => {
            let module = {};

            module.crawl = (url, callback) => {
                $.ajax({
                    type: "post",
                    url: "/api/crawler/manga",
                    data: { url: url },
                    success: (response) => {
                        callback(response);
                    }
                });
            }
            return module;
        })();

        function crawlManga(url) {
            isComplete = false;
            CrawlerService.crawl(url, (response) => {
                console.log(response);
                if (response.total - response.curent > 0) {
                    crawlManga(url);
                    attemp += 1;
                    let status;
                    if (attemp > 1) {
                        status = `Hãy cố gắng đợi một chút!<br>Đợt: ${attemp}<br> Tiến độ: ${response.curent}/${response.total} chap`;
                    }
                    $("#crawling_status").html(status);
                } else {
                    attemp = 1;
                    $("#crawling_status").html("Đang cào dữ liệu...");
                    isComplete = true;
                    swal({
                        title: "Xong!",
                        text: response.status,
                        icon: "success",
                        button: "Ok",
                    });
                }

            })
        }

        $("#btn-crawl").click((ev) => {
            let getUrl = $("#url-crawl").val().trim();
            if (getUrl) {
                crawlManga(getUrl);
            }
        });
    });
</script>